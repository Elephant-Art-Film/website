---
interface Props {
  stills: string[];
  title?: string;
  columns?: 2 | 3 | 4;
}

const { stills, title = 'Still', columns = 3 } = Astro.props;

/** Stable unique id */
const gid = `gallery-${Math.random().toString(36).slice(2, 10)}`;

const colConfig = {
  2: 'sm:grid-cols-2',
  4: 'sm:grid-cols-2 lg:grid-cols-4',
  3: 'sm:grid-cols-2 lg:grid-cols-3'
};
const colClass = colConfig[columns] || colConfig[3];
---

<div class="stills-gallery" data-gallery-id={gid}>
  <div class={`stills-grid grid grid-cols-1 ${colClass} gap-3`}>
    {
      stills.map((src, index) => (
        <button
          type="button"
          class="still"
          data-index={index}
          aria-label={`Open ${title} still ${index + 1}`}
        >
          <img
            src={src}
            loading="lazy"
            alt={`${title} — Still ${index + 1}`}
            class="still-img"
          />
        </button>
      ))
    }
  </div>

  <div class="lightbox" aria-hidden="true" tabindex="-1">
    <div class="lightbox-backdrop" data-close></div>

    <div class="lightbox-panel" role="dialog" aria-modal="true" aria-label="Image viewer">
      <button class="lightbox-close" type="button" data-close aria-label="Close">×</button>

      <button class="lightbox-nav lightbox-prev" type="button" data-prev aria-label="Previous">‹</button>

      <figure class="lightbox-figure">
        <img class="lightbox-img" data-lightbox-img alt="" />
      </figure>

      <button class="lightbox-nav lightbox-next" type="button" data-next aria-label="Next">›</button>
    </div>
  </div>
</div>

<style>
  /* ... Your existing styles are fine ... */
  .lightbox-img {
    transition: opacity 0.2s ease-in-out;
  }
</style>

<script is:inline>
  (() => {
    // FIX: Instead of variable interpolation, find the script's parent container
    const scripts = document.getElementsByTagName('script');
    const currentScript = scripts[scripts.length - 1];
    const root = currentScript.closest('.stills-gallery');
    
    if (!root) return;

    const buttons = Array.from(root.querySelectorAll('button.still'));
    const lightbox = root.querySelector('.lightbox');
    const img = root.querySelector('[data-lightbox-img]');

    if (!lightbox || !img || buttons.length === 0) return;

    const sources = buttons
      .map((b) => b.querySelector('img')?.getAttribute('src'))
      .filter(Boolean);

    let currentIndex = 0;

    function updateImage(i) {
      currentIndex = i;
      img.style.opacity = '0'; // Smooth transition
      img.src = sources[currentIndex];
      img.alt = `Still ${currentIndex + 1}`;
      
      // Fade back in once loaded
      img.onload = () => { img.style.opacity = '1'; };
    }

    function openAt(i) {
      updateImage(i);
      lightbox.classList.add('is-open');
      lightbox.setAttribute('aria-hidden', 'false');
      document.documentElement.style.overflow = 'hidden';
      lightbox.focus();
    }

    function close() {
      lightbox.classList.remove('is-open');
      lightbox.setAttribute('aria-hidden', 'true');
      document.documentElement.style.overflow = '';
      img.src = ''; 
    }

    function prev() {
      updateImage((currentIndex - 1 + sources.length) % sources.length);
    }

    function next() {
      updateImage((currentIndex + 1) % sources.length);
    }

    // Event Listeners
    buttons.forEach((btn, i) => btn.addEventListener('click', () => openAt(i)));

    root.querySelectorAll('[data-close]').forEach((el) => el.addEventListener('click', close));
    root.querySelector('[data-prev]')?.addEventListener('click', (e) => { e.stopPropagation(); prev(); });
    root.querySelector('[data-next]')?.addEventListener('click', (e) => { e.stopPropagation(); next(); });

    // Global keys only if THIS lightbox is open
    window.addEventListener('keydown', (e) => {
      if (!lightbox.classList.contains('is-open')) return;
      if (e.key === 'Escape') close();
      if (e.key === 'ArrowLeft') prev();
      if (e.key === 'ArrowRight') next();
    });
  })();
</script>