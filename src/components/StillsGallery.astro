---
interface Props {
  stills: string[];
  title?: string;
  columns?: 2 | 3 | 4;
}

const { stills, title = 'Still', columns = 3 } = Astro.props;

const colClass =
  columns === 2
    ? 'sm:grid-cols-2'
    : columns === 4
    ? 'sm:grid-cols-2 lg:grid-cols-4'
    : 'sm:grid-cols-2 lg:grid-cols-3';
---

<div class="stills-gallery" data-gallery>
  <div class={`stills-grid grid grid-cols-1 ${colClass} gap-2`}>
    {
      stills.map((src, index) => (
        <button
          type="button"
          class="still"
          data-index={index}
          aria-label={`Open ${title} ${index + 1}`}
        >
          <img
            src={src}
            loading="lazy"
            alt={`${title} ${index + 1}`}
            class="still-img"
          />
        </button>
      ))
    }
  </div>

  <!-- Lightbox -->
  <div class="lightbox" data-lightbox aria-hidden="true">
    <div class="lightbox-backdrop" data-close></div>

    <div class="lightbox-panel" role="dialog" aria-modal="true" aria-label="Image viewer">
      <button class="lightbox-close" type="button" data-close aria-label="Close">×</button>

      <button class="lightbox-nav lightbox-prev" type="button" data-prev aria-label="Previous">‹</button>
      <figure class="lightbox-figure">
        <img class="lightbox-img" data-lightbox-img alt="" />
      </figure>
      <button class="lightbox-nav lightbox-next" type="button" data-next aria-label="Next">›</button>
    </div>
  </div>
</div>

<style>
  /* ===== Grid thumbnails ===== */
  .still {
    display: block;
    border: 0;
    padding: 0;
    background: transparent;
    cursor: zoom-in;
    text-align: left;
  }

  .still-img {
    width: 100%;
    height: 100%;
    aspect-ratio: 16 / 10;
    object-fit: cover;
    display: block;
    background: rgba(0,0,0,0.35);
    transition: transform 180ms ease, opacity 180ms ease;
    opacity: 0.92;
  }

  .still:hover .still-img {
    transform: scale(1.01);
    opacity: 1;
  }

  .still:focus-visible {
    outline: 2px solid rgba(255,255,255,0.25);
    outline-offset: 4px;
  }

  /* ===== Lightbox ===== */
  .lightbox {
    position: fixed;
    inset: 0;
    display: none;
    z-index: 60;
  }

  .lightbox.is-open {
    display: block;
  }

  .lightbox-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.75);
    backdrop-filter: blur(6px);
  }

  .lightbox-panel {
    position: relative;
    height: 100%;
    display: grid;
    grid-template-columns: 56px 1fr 56px;
    align-items: center;
    padding: 24px;
  }

  .lightbox-figure {
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 0;
  }

  .lightbox-img {
    max-width: min(1200px, 92vw);
    max-height: 84vh;
    width: auto;
    height: auto;
    object-fit: contain;
    background: #000;
    box-shadow: 0 18px 60px rgba(0,0,0,0.6);
  }

  .lightbox-close {
    position: absolute;
    top: 14px;
    right: 14px;
    width: 42px;
    height: 42px;
    border: 0;
    border-radius: 999px;
    background: rgba(255,255,255,0.10);
    color: rgba(255,255,255,0.9);
    font-size: 26px;
    line-height: 42px;
    cursor: pointer;
    transition: background 160ms ease;
  }
  .lightbox-close:hover {
    background: rgba(255,255,255,0.16);
  }

  .lightbox-nav {
    border: 0;
    background: transparent;
    color: rgba(255,255,255,0.85);
    font-size: 56px;
    height: 72px;
    cursor: pointer;
    opacity: 0.75;
    transition: opacity 160ms ease;
  }
  .lightbox-nav:hover {
    opacity: 1;
  }

  @media (max-width: 640px) {
    .lightbox-panel {
      grid-template-columns: 44px 1fr 44px;
      padding: 16px;
    }
    .lightbox-nav { font-size: 44px; }
    .lightbox-img { max-height: 78vh; }
  }
</style>

<script>
  const root = document.currentScript?.closest('[data-gallery]');
  if (!root) {};

  const buttons = root?.querySelectorAll('button.still') || [];
  const lightbox = root?.querySelector('[data-lightbox]');
  const img = root?.querySelector('[data-lightbox-img]');

  const sources = Array.from(buttons).map((b) => b.querySelector('img')?.getAttribute('src')).filter(Boolean);

  let index = 0;

  function openAt(i) {
    index = i;
    if (!lightbox || !img) return;

    img.src = sources[index];
    img.alt = `Still ${index + 1}`;

    lightbox.classList.add('is-open');
    lightbox.setAttribute('aria-hidden', 'false');
    document.documentElement.style.overflow = 'hidden';
  }

  function close() {
    if (!lightbox || !img) return;

    lightbox.classList.remove('is-open');
    lightbox.setAttribute('aria-hidden', 'true');
    document.documentElement.style.overflow = '';

    // prevent flash of old image on next open
    img.src = '';
    img.alt = '';
  }

  function prev() {
    if (!sources.length) return;
    index = (index - 1 + sources.length) % sources.length;
    if (img) img.src = sources[index];
  }

  function next() {
    if (!sources.length) return;
    index = (index + 1) % sources.length;
    if (img) img.src = sources[index];
  }

  buttons.forEach((btn, i) => {
    btn.addEventListener('click', () => openAt(i));
  });

  root?.querySelectorAll('[data-close]')?.forEach((el) => el.addEventListener('click', close));
  root?.querySelector('[data-prev]')?.addEventListener('click', prev);
  root?.querySelector('[data-next]')?.addEventListener('click', next);

  window.addEventListener('keydown', (e) => {
    if (!lightbox?.classList.contains('is-open')) return;

    if (e.key === 'Escape') close();
    if (e.key === 'ArrowLeft') prev();
    if (e.key === 'ArrowRight') next();
  });
</script>