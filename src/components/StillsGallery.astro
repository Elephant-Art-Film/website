---
interface Props {
  stills: string[];
  title?: string;
}

const { stills, title = 'Film Still' } = Astro.props;
const gid = `gallery-${Math.random().toString(36).slice(2, 6)}`;
---

<div class="film-gallery" data-gallery-id={gid}>
  <div class="grid-container">
    {
      stills.map((src, index) => (
        <button
          type="button"
          class="still-link"
          data-index={index}
          aria-label={`Open ${title} ${index + 1}`}
        >
          <img 
            src={src} 
            alt={`${title} ${index + 1}`} 
            loading="lazy"
            class="thumbnail-img" 
          />
        </button>
      ))
    }
  </div>

  <dialog class="lightbox-root">
    <div class="lightbox-ui">
      <button class="ui-close" data-close aria-label="Close">âœ•</button>
      
      <div class="ui-main">
        <button class="ui-nav" data-prev aria-label="Previous">prev</button>
        <figure class="ui-figure">
          <img class="ui-img" src="" alt="" />
        </figure>
        <button class="ui-nav" data-next aria-label="Next">next</button>
      </div>

      <div class="ui-footer">
        <span class="ui-counter"><span id="curr">1</span> / {stills.length}</span>
      </div>
    </div>
  </dialog>
</div>

<style>
  .film-gallery {
    margin: 3rem 0;
    --gap: 16px;
  }

  /* 3-column grid that respects original height/ratio */
  .grid-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--gap);
    align-items: start;
  }

  .still-link {
    border: none;
    padding: 0;
    background: transparent;
    cursor: zoom-in;
    transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1), opacity 0.3s ease;
  }

  .thumbnail-img {
    width: 100%;
    height: auto; /* Maintains original aspect ratio */
    display: block;
    border-radius: 2px;
  }

  .still-link:hover {
    opacity: 0.9;
    transform: translateY(-2px);
  }

  /* Lightbox Styles */
  .lightbox-root {
    border: none;
    padding: 0;
    background: transparent;
    width: 100vw;
    height: 100vh;
    max-width: 100vw;
    max-height: 100vh;
    overflow: hidden;
  }

  .lightbox-root::backdrop {
    background: rgba(10, 10, 10, 0.98);
    backdrop-filter: blur(12px);
  }

  .lightbox-ui {
    display: flex;
    flex-direction: column;
    height: 100%;
    color: #fff;
  }

  .ui-main {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 4vw;
  }

  .ui-figure {
    margin: 0;
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .ui-img {
    max-width: 90vw;
    max-height: 80vh;
    object-fit: contain;
    transition: opacity 0.2s ease;
  }

  .ui-nav {
    background: none;
    border: none;
    color: rgba(255,255,255,0.3);
    font-family: serif;
    font-style: italic;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    cursor: pointer;
    padding: 2rem;
    transition: color 0.3s ease;
  }

  .ui-nav:hover { color: #fff; }

  .ui-close {
    position: absolute;
    top: 2rem;
    right: 2rem;
    background: none;
    border: none;
    color: #fff;
    font-size: 1.5rem;
    cursor: pointer;
    z-index: 100;
  }

  .ui-footer {
    padding: 2rem;
    text-align: center;
    font-family: monospace;
    font-size: 0.7rem;
    letter-spacing: 0.3em;
    opacity: 0.4;
  }

  @media (max-width: 900px) {
    .grid-container { grid-template-columns: repeat(2, 1fr); }
  }

  @media (max-width: 600px) {
    .grid-container { grid-template-columns: 1fr; }
    .ui-nav { display: none; }
  }
</style>

<script is:inline>
  (() => {
    const script = document.currentScript;
    const gid = script?.closest('.film-gallery')?.dataset.galleryId;

    // Prefer: exact instance by data-gallery-id (works even if DOM shifts)
    const root =
      (gid && document.querySelector(`.film-gallery[data-gallery-id="${gid}"]`)) ||
      script?.closest('.film-gallery');

    if (!root) return;

    const dialog = root.querySelector('.lightbox-root');
    const mainImg = root.querySelector('.ui-img');
    const counter = root.querySelector('#curr');
    const buttons = Array.from(root.querySelectorAll('.still-link'));
    const sources = buttons.map(b => b.querySelector('img')?.src).filter(Boolean);

    if (!dialog || !mainImg || !counter || sources.length === 0) return;

    let currentIndex = 0;

    const updateView = (index) => {
      currentIndex = index;
      mainImg.style.opacity = '0';
      mainImg.src = sources[currentIndex];
      counter.textContent = String(currentIndex + 1);
      mainImg.onload = () => (mainImg.style.opacity = '1');
    };

    buttons.forEach((btn, i) => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        updateView(i);

        // guard for browsers without <dialog> support
        if (typeof dialog.showModal === 'function') {
          dialog.showModal();
          document.body.style.overflow = 'hidden';
        } else {
          // minimal fallback: make it visible (optional)
          dialog.setAttribute('open', '');
          document.body.style.overflow = 'hidden';
        }
      });
    });

    // Close should also restore scrolling even on ESC (native dialog close)
    dialog.addEventListener('close', () => {
      document.body.style.overflow = '';
    });

    root.addEventListener('click', (e) => {
      if (e.target.closest('[data-close]')) dialog.close();
      if (e.target.closest('[data-prev]')) updateView((currentIndex - 1 + sources.length) % sources.length);
      if (e.target.closest('[data-next]')) updateView((currentIndex + 1) % sources.length);
    });

    dialog.addEventListener('click', (e) => {
      if (e.target === dialog) dialog.close();
    });

    window.addEventListener('keydown', (e) => {
      if (!dialog.open) return;
      if (e.key === 'ArrowLeft') updateView((currentIndex - 1 + sources.length) % sources.length);
      if (e.key === 'ArrowRight') updateView((currentIndex + 1) % sources.length);
    });
  })();
</script>