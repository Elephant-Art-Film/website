---
interface Props {
  stills: string[];
  title?: string;
}

const { stills, title = 'Film Still' } = Astro.props;
const gid = `gallery-${Math.random().toString(36).slice(2, 6)}`;
---

<div class="film-gallery" data-gallery-id={gid}>
  <div class="grid-container">
    {
      stills.map((src, index) => (
        <button
          type="button"
          class="still-link"
          data-index={index}
          aria-label={`Open ${title} ${index + 1}`}
        >
          <img 
            src={src} 
            alt={`${title} ${index + 1}`} 
            loading="lazy"
            class="thumbnail-img" 
          />
        </button>
      ))
    }
  </div>

  <dialog class="lightbox-root">
    <div class="lightbox-ui">
      <button class="ui-close" data-close aria-label="Close">âœ•</button>
      
      <div class="ui-main">
        <button class="ui-nav" data-prev aria-label="Previous">prev</button>
        <figure class="ui-figure">
          <img class="ui-img" src="" alt="" />
        </figure>
        <button class="ui-nav" data-next aria-label="Next">next</button>
      </div>

      <div class="ui-footer">
        <span class="ui-counter"><span id="curr">1</span> / {stills.length}</span>
      </div>
    </div>
  </dialog>
</div>

<style>
  .film-gallery {
    margin: 3rem 0;
    --gap: 16px;
  }

  /* 3-column grid that respects original height/ratio */
  .grid-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--gap);
    align-items: start;
  }

  .still-link {
    border: none;
    padding: 0;
    background: transparent;
    cursor: zoom-in;
    transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1), opacity 0.3s ease;
  }

  .thumbnail-img {
    width: 100%;
    height: auto; /* Maintains original aspect ratio */
    display: block;
    border-radius: 2px;
  }

  .still-link:hover {
    opacity: 0.9;
    transform: translateY(-2px);
  }

  /* Lightbox Styles */
  .lightbox-root {
    border: none;
    padding: 0;
    background: transparent;
    width: 100vw;
    height: 100vh;
    max-width: 100vw;
    max-height: 100vh;
    overflow: hidden;
  }

  .lightbox-root::backdrop {
    background: rgba(10, 10, 10, 0.98);
    backdrop-filter: blur(12px);
  }

  .lightbox-ui {
    display: flex;
    flex-direction: column;
    height: 100%;
    color: #fff;
  }

  .ui-main {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 4vw;
  }

  .ui-figure {
    margin: 0;
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .ui-img {
    max-width: 90vw;
    max-height: 80vh;
    object-fit: contain;
    transition: opacity 0.2s ease;
  }

  .ui-nav {
    background: none;
    border: none;
    color: rgba(255,255,255,0.3);
    font-family: serif;
    font-style: italic;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    cursor: pointer;
    padding: 2rem;
    transition: color 0.3s ease;
  }

  .ui-nav:hover { color: #fff; }

  .ui-close {
    position: absolute;
    top: 2rem;
    right: 2rem;
    background: none;
    border: none;
    color: #fff;
    font-size: 1.5rem;
    cursor: pointer;
    z-index: 100;
  }

  .ui-footer {
    padding: 2rem;
    text-align: center;
    font-family: monospace;
    font-size: 0.7rem;
    letter-spacing: 0.3em;
    opacity: 0.4;
  }

  @media (max-width: 900px) {
    .grid-container { grid-template-columns: repeat(2, 1fr); }
  }

  @media (max-width: 600px) {
    .grid-container { grid-template-columns: 1fr; }
    .ui-nav { display: none; }
  }
</style>

<script is:inline>
  (() => {
    const stateByGallery = new WeakMap();

    function getGalleryState(root) {
      let st = stateByGallery.get(root);
      if (st) return st;

      const dialog = root.querySelector('.lightbox-root');
      const mainImg = root.querySelector('.ui-img');
      const counter = root.querySelector('#curr');
      const buttons = Array.from(root.querySelectorAll('.still-link'));
      const sources = buttons
        .map(b => b.querySelector('img'))
        .map(img => img?.getAttribute('src') || img?.src)
        .filter(Boolean);

      st = { dialog, mainImg, counter, buttons, sources, currentIndex: 0 };
      stateByGallery.set(root, st);
      return st;
    }

    function openAt(root, index) {
      const st = getGalleryState(root);
      if (!st.dialog || !st.mainImg || !st.counter || st.sources.length === 0) return;

      st.currentIndex = index;

      st.mainImg.style.opacity = '0';
      st.mainImg.src = st.sources[st.currentIndex];
      st.counter.textContent = String(st.currentIndex + 1);
      st.mainImg.onload = () => (st.mainImg.style.opacity = '1');

      if (typeof st.dialog.showModal === 'function') {
        st.dialog.showModal();
      } else {
        // fallback for browsers without <dialog>
        st.dialog.setAttribute('open', '');
      }

      document.body.style.overflow = 'hidden';
    }

    function close(root) {
      const st = getGalleryState(root);
      if (!st.dialog) return;

      if (typeof st.dialog.close === 'function') st.dialog.close();
      else st.dialog.removeAttribute('open');

      document.body.style.overflow = '';
    }

    function nav(root, dir) {
      const st = getGalleryState(root);
      if (!st.dialog || !st.dialog.open || st.sources.length === 0) return;

      st.currentIndex = (st.currentIndex + dir + st.sources.length) % st.sources.length;
      st.mainImg.style.opacity = '0';
      st.mainImg.src = st.sources[st.currentIndex];
      st.counter.textContent = String(st.currentIndex + 1);
      st.mainImg.onload = () => (st.mainImg.style.opacity = '1');
    }

    // One click handler for the whole document (works across Astro page swaps)
    document.addEventListener('click', (e) => {
      const thumbBtn = e.target.closest('.film-gallery .still-link');
      if (thumbBtn) {
        e.preventDefault();
        const root = thumbBtn.closest('.film-gallery');
        if (!root) return;
        const index = Number(thumbBtn.dataset.index || 0);
        openAt(root, index);
        return;
      }

      const root = e.target.closest('.film-gallery');
      if (!root) return;

      if (e.target.closest('[data-close]')) { close(root); return; }
      if (e.target.closest('[data-prev]'))  { nav(root, -1); return; }
      if (e.target.closest('[data-next]'))  { nav(root, +1); return; }
    });

    // backdrop click (only works for real <dialog>)
    document.addEventListener('click', (e) => {
      const dialog = e.target;
      if (dialog?.matches?.('dialog.lightbox-root') && e.target === dialog) {
        const root = dialog.closest('.film-gallery');
        if (root) close(root);
      }
    });

    // ESC / arrows
    window.addEventListener('keydown', (e) => {
      const openDialog = document.querySelector('dialog.lightbox-root[open]');
      if (!openDialog) return;
      const root = openDialog.closest('.film-gallery');
      if (!root) return;

      if (e.key === 'Escape') close(root);
      if (e.key === 'ArrowLeft') nav(root, -1);
      if (e.key === 'ArrowRight') nav(root, +1);
    });

    // if user closes via native dialog behavior, restore scroll
    document.addEventListener('close', (e) => {
      if (e.target?.matches?.('dialog.lightbox-root')) document.body.style.overflow = '';
    }, true);
  })();
</script>