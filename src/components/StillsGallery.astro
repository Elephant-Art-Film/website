---
interface Props {
  stills: string[];
  title?: string;
  columns?: 2 | 3 | 4;
}

const { stills, title = 'Still', columns = 3 } = Astro.props;

/** Make a stable unique id so the script can target the right gallery */
const gid = `gallery-${Math.random().toString(36).slice(2, 10)}`;

const colConfig = {
  2: 'sm:grid-cols-2',
  4: 'sm:grid-cols-2 lg:grid-cols-4',
  3: 'sm:grid-cols-2 lg:grid-cols-3'
};
const colClass = colConfig[columns] || colConfig[3];
---

<div class="stills-gallery" data-gallery-id={gid}>
  <div class={`stills-grid grid grid-cols-1 ${colClass} gap-3`}>
    {
      stills.map((src, index) => (
        <button
          type="button"
          class="still"
          data-index={index}
          aria-label={`Open ${title} still ${index + 1}`}
        >
          <img
            src={src}
            loading="lazy"
            alt={`${title} — Still ${index + 1}`}
            class="still-img"
          />
        </button>
      ))
    }
  </div>

  <!-- Lightbox -->
  <div class="lightbox" aria-hidden="true">
    <div class="lightbox-backdrop" data-close></div>

    <div class="lightbox-panel" role="dialog" aria-modal="true" aria-label="Image viewer">
      <button class="lightbox-close" type="button" data-close aria-label="Close">×</button>

      <button class="lightbox-nav lightbox-prev" type="button" data-prev aria-label="Previous">‹</button>

      <figure class="lightbox-figure">
        <img class="lightbox-img" data-lightbox-img alt="" />
      </figure>

      <button class="lightbox-nav lightbox-next" type="button" data-next aria-label="Next">›</button>
    </div>
  </div>
</div>

<style>
  /* Thumbnails keep original ratio (no crop) */
  .still {
    border: 0;
    padding: 0;
    background: transparent;
    cursor: zoom-in;
    display: block;
  }

  .still-img {
    width: 100%;
    height: auto;            /* keep original ratio */
    display: block;
    opacity: 0.92;
    transition: opacity 180ms ease, transform 180ms ease;
  }

  .still:hover .still-img {
    opacity: 1;
    transform: translateY(-1px);
  }

  .still:focus-visible {
    outline: 2px solid rgba(255,255,255,0.25);
    outline-offset: 4px;
  }

  /* Lightbox */
  .lightbox {
    position: fixed;
    inset: 0;
    display: none;
    z-index: 70;
  }
  .lightbox.is-open {
    display: block;
  }

  .lightbox-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.78);
    backdrop-filter: blur(6px);
  }

  .lightbox-panel {
    position: relative;
    height: 100%;
    display: grid;
    grid-template-columns: 56px 1fr 56px;
    align-items: center;
    padding: 24px;
  }

  .lightbox-figure {
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 0;
  }

  .lightbox-img {
    max-width: min(1400px, 92vw);
    max-height: 86vh;
    width: auto;
    height: auto;
    object-fit: contain;
    background: #000;
    box-shadow: 0 18px 60px rgba(0,0,0,0.6);
  }

  .lightbox-close {
    position: absolute;
    top: 14px;
    right: 14px;
    width: 42px;
    height: 42px;
    border: 0;
    border-radius: 999px;
    background: rgba(255,255,255,0.10);
    color: rgba(255,255,255,0.9);
    font-size: 26px;
    line-height: 42px;
    cursor: pointer;
    transition: background 160ms ease;
  }
  .lightbox-close:hover {
    background: rgba(255,255,255,0.16);
  }

  .lightbox-nav {
    border: 0;
    background: transparent;
    color: rgba(255,255,255,0.85);
    font-size: 56px;
    height: 72px;
    cursor: pointer;
    opacity: 0.75;
    transition: opacity 160ms ease;
    user-select: none;
  }
  .lightbox-nav:hover {
    opacity: 1;
  }

  @media (max-width: 640px) {
    .lightbox-panel {
      grid-template-columns: 44px 1fr 44px;
      padding: 16px;
    }
    .lightbox-nav { font-size: 44px; }
    .lightbox-img { max-height: 80vh; }
  }
</style>

<script is:inline>
  // Use a self-executing function to avoid global scope pollution
  (() => {
    // Find the closest gallery container to this script
    const root = document.currentScript.closest('.stills-gallery');
    if (!root) return;

    const lightbox = root.querySelector('.lightbox');
    const img = root.querySelector('[data-lightbox-img]');
    const buttons = Array.from(root.querySelectorAll('button.still'));
    const sources = buttons.map(b => b.querySelector('img')?.src).filter(Boolean);
    
    let index = 0;

    const updateImage = (i) => {
      index = i;
      img.style.opacity = '0'; // Optional: fade out
      img.src = sources[index];
      img.alt = `Still ${index + 1}`;
      img.onload = () => img.style.opacity = '1'; // Optional: fade in
    };

    const open = (i) => {
      updateImage(i);
      lightbox.classList.add('is-open');
      document.body.style.overflow = 'hidden';
    };

    const close = () => {
      lightbox.classList.remove('is-open');
      document.body.style.overflow = '';
    };

    // Event Delegation for Nav
    root.addEventListener('click', (e) => {
      if (e.target.closest('[data-close]')) close();
      if (e.target.closest('[data-prev]')) updateImage((index - 1 + sources.length) % sources.length);
      if (e.target.closest('[data-next]')) updateImage((index + 1) % sources.length);
    });

    buttons.forEach((btn, i) => btn.addEventListener('click', () => open(i)));

    window.addEventListener('keydown', (e) => {
      if (!lightbox.classList.contains('is-open')) return;
      if (e.key === 'Escape') close();
      if (e.key === 'ArrowLeft') root.querySelector('[data-prev]').click();
      if (e.key === 'ArrowRight') root.querySelector('[data-next]').click();
    });
  })();
</script>