---
import type { GetStaticPaths } from 'astro';
import { getCollection, getEntry } from 'astro:content';

import MasterLayout from '../layouts/master.astro';
import UnorderedList from '../components/UnorderedList.astro';

import iconIMDb from '../icons/imdb.svg?raw';
import iconWatch from '../icons/watch.svg?raw';
import iconZip from '../icons/zip.svg?raw';
import Heading1 from '../components/Heading1.astro';
import Heading2 from '../components/Heading2.astro';

export const getStaticPaths = (async () => {
	const films = await getCollection('films');
	return films.map((film) => {
		return { params: { film: film.slug } };
	});
}) satisfies GetStaticPaths;

const { film: slug } = Astro.params;
if (!slug) throw new Error('Missing slug');

const film = await getEntry<'films', string>('films', slug);
if (!film) throw new Error('Missing film');

const { Content } = await film.render();
---

<MasterLayout title={`ELEPHANT | ${film.data.title}`} description="">
	<img src={film.data.cover} alt={film.data.title} />
	<h1 class="text-4xl font-bold my-4">{film.data.title}</h1>
	<div class="text-md my-1">{film.data.genre.join(' · ')}</div>
	<div class="text-md my-1">
		{film.data.year} · {film.data.runtime} · {film.data.aspectRatio} · {film.data.color} · {film.data.soundFormat}
	</div>
	<div class="flex items-center gap-3 float-none sm:float-right mt-6 sm:-mt-12">
		{
			film.data.pressPack && (
				<a
					href={film.data.pressPack}
					target="_blank"
					class="h-full"
					aria-label="Press Pack"
				>
					<Fragment set:html={iconZip} />
				</a>
			)
		}
		{
			film.data.imdbId && (
				<a
					href={`https://www.imdb.com/title/${film.data.imdbId}/`}
					target="_blank"
					class="h-full"
					aria-label="IMDb"
				>
					<Fragment set:html={iconIMDb} />
				</a>
			)
		}
		{
			film.data.watchUrl && (
				<a
					href={film.data.watchUrl}
					target="_blank"
					class="h-full"
					aria-label="Watch Online"
				>
					<Fragment set:html={iconWatch} />
				</a>
			)
		}
	</div>

	<article id="film-content" class="prose-lg lg:prose-xl my-8">
		<Content components={{ ul: UnorderedList, h1: Heading1, h2: Heading2 }} />
	</article>

	<!-- Section Tabs Navigation (hidden initially, moved into position by JS) -->
	<nav id="section-tabs" class="hidden sticky top-0 z-20 -mx-12 px-12 mt-8 mb-4 bg-black/70 backdrop-blur-md border-b border-white/10">
		<div class="scrollbar-hide flex items-center gap-8 overflow-x-auto" id="tabs-container">
			<!-- Tabs injected dynamically -->
		</div>
	</nav>

</MasterLayout>

<style>
	.scrollbar-hide::-webkit-scrollbar {
		display: none;
	}
	.scrollbar-hide {
		-ms-overflow-style: none;
		scrollbar-width: none;
	}

	.section-tab {
  /* IMPORTANT: do NOT flex:1 for long labels */
  flex: 0 0 auto;

  position: relative;
  display: inline-flex;
  align-items: center;
  justify-content: center;

  padding: 0.9rem 0;            /* no “button box”, just label spacing */
  font-size: 1rem;
  font-weight: 500;
  letter-spacing: 0.01em;
  text-transform: none;         /* matches the reference */
  white-space: nowrap;

  color: rgba(255, 255, 255, 0.55);
  background: transparent;
  border: none;
  cursor: pointer;
  transition: color 180ms ease;
}

.section-tab:hover {
  color: rgba(255, 255, 255, 0.8);
}

.section-tab::after {
  content: "";
  position: absolute;
  left: 0;
  right: 0;
  bottom: -1px;                 /* sits over the nav border */
  height: 2px;
  background: transparent;
  border-radius: 999px;
  transition: background 180ms ease;
}

.section-tab.active {
  color: rgba(255, 255, 255, 0.95);
}

.section-tab.active::after {
  background: rgba(255, 255, 255, 0.95);
}

/* Optional: keyboard focus */
.section-tab:focus-visible {
  outline: 2px solid rgba(255,255,255,0.25);
  outline-offset: 4px;
  border-radius: 6px;
}

</style>

<script>
	function initSectionTabs() {
		const article = document.getElementById('film-content');
		const tabNav = document.getElementById('section-tabs');
		const tabsContainer = document.getElementById('tabs-container');

		if (!article || !tabNav || !tabsContainer) return;

		// Find all h2 elements within the article
		const headings = article.querySelectorAll('h2[id]');
		if (headings.length === 0) return;

		// Move the tab nav into the article, right before the first h2
		const firstH2 = headings[0];
		firstH2.parentNode?.insertBefore(tabNav, firstH2);
		tabNav.classList.remove('hidden');

		// Create tab buttons
		headings.forEach((heading) => {
			const btn = document.createElement('button');
			btn.className = 'section-tab';
			btn.textContent = heading.textContent || '';
			btn.dataset.target = heading.id;

			btn.addEventListener('click', () => {
				const target = document.getElementById(heading.id);
				if (target) {
					const offset = tabNav.offsetHeight + 16;
					const top = target.getBoundingClientRect().top + window.scrollY - offset;
					window.scrollTo({ top, behavior: 'smooth' });
				}
			});

			tabsContainer.appendChild(btn);
		});

		// Active state tracking via IntersectionObserver
		const tabs = tabsContainer.querySelectorAll('.section-tab');

		function setActiveTab(targetId: string) {
			tabs.forEach((tab) => {
				if ((tab as HTMLElement).dataset.target === targetId) {
					tab.classList.add('active');
				} else {
					tab.classList.remove('active');
				}
			});
			const active = [...tabs].find(t => t.dataset.target === targetId);
			active?.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });

		}

		// Observe each heading
		const observer = new IntersectionObserver(
			(entries) => {
				for (const entry of entries) {
					if (entry.isIntersecting) {
						setActiveTab(entry.target.id);
						break;
					}
				}
			},
			{
				rootMargin: '-80px 0px -60% 0px',
				threshold: 0,
			}
		);

		headings.forEach((heading) => observer.observe(heading));

		// Set the first tab as active initially
		if (tabs.length > 0) {
			tabs[0].classList.add('active');
		}
	}

	initSectionTabs();
</script>
