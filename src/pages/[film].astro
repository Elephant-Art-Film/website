---
import type { GetStaticPaths } from 'astro';
import { getCollection, getEntry } from 'astro:content';

import MasterLayout from '../layouts/master.astro';
import UnorderedList from '../components/UnorderedList.astro';
import YouTube from '../components/YouTube.astro';
import StillsGallery from '../components/StillsGallery.astro';
import iconIMDb from '../icons/imdb.svg?raw';
import iconWatch from '../icons/watch.svg?raw';
import iconZip from '../icons/zip.svg?raw';
import Heading1 from '../components/Heading1.astro';
import Heading2 from '../components/Heading2.astro';

export const getStaticPaths = (async () => {
	const films = await getCollection('films');
	return films.map((film) => {
		return { params: { film: film.slug } };
	});
}) satisfies GetStaticPaths;

const { film: slug } = Astro.params;
if (!slug) throw new Error('Missing slug');

const film = await getEntry<'films', string>('films', slug);
if (!film) throw new Error('Missing film');

const { Content } = await film.render();
---

<MasterLayout title={`ELEPHANT | ${film.data.title}`} description="">
	<img src={film.data.cover} alt={film.data.title} />
	<h1 class="text-4xl font-bold my-4">{film.data.title}</h1>
	<div class="text-md my-1">{film.data.genre.join(' · ')}</div>
	<div class="text-md my-1">
		{film.data.year} · {film.data.runtime} · {film.data.aspectRatio} · {film.data.color} · {film.data.soundFormat}
	</div>
	<div class="flex items-center gap-3 float-none sm:float-right mt-6 sm:-mt-12">
		{
			film.data.pressPack && (
				<a
					href={film.data.pressPack}
					target="_blank"
					class="h-full"
					aria-label="Press Pack"
				>
					<Fragment set:html={iconZip} />
				</a>
			)
		}
		
		{
			film.data.watchUrl && (
				<a
					href={film.data.watchUrl}
					target="_blank"
					class="h-full"
					aria-label="Watch Online"
				>
					<Fragment set:html={iconWatch} />
				</a>
			)
		}
		{
			film.data.imdbId && (
				<a
					href={`https://www.imdb.com/title/${film.data.imdbId}/`}
					target="_blank"
					class="h-full"
					aria-label="IMDb"
				>
					<Fragment set:html={iconIMDb} />
				</a>
			)
		}
	</div>

	<article id="film-content" class="prose-lg lg:prose-xl my-8">
		<Content components={{ ul: UnorderedList, h1: Heading1, h2: Heading2 }} />
	</article>

	<!-- Section Tabs Navigation (hidden initially, moved into position by JS) -->
<nav
  id="section-tabs"
  class="hidden sticky top-0 z-20 -mx-12 px-12 mt-10 mb-6 pt-3 border-b border-white/15"
>
  <div class="scrollbar-hide flex items-center gap-10 overflow-x-auto" id="tabs-container"></div>
</nav>


</MasterLayout>

<style is:global>
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }

  .section-tab {
    flex: 0 0 auto;
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;

    padding: 0.75rem 0;
    font-size: 1rem;
    font-weight: 500;
    letter-spacing: 0.01em;
    text-transform: none;
    white-space: nowrap;

    color: rgba(255, 255, 255, 0.45);
    background: transparent;
    border: 0;
    cursor: pointer;
    transition: color 180ms ease, font-weight 180ms ease;
  }

  .section-tab::after {
    content: "";
    position: absolute;
    left: 0;
    right: 0;
    bottom: -1px;
    height: 2px;
    background: transparent;
    border-radius: 999px;
    transition: background 180ms ease, box-shadow 180ms ease;
  }

  .section-tab:hover {
    color: rgba(255, 255, 255, 0.8);
  }

  .section-tab.active {
    color: rgba(255, 255, 255, 1);
    font-weight: 600;
  }

  .section-tab.active::after {
    background: rgba(255, 255, 255, 0.95);
    box-shadow: 0 0 12px rgba(255, 255, 255, 0.3);
  }

  .section-tab:focus-visible {
    outline: 2px solid rgba(255, 255, 255, 0.25);
    outline-offset: 4px;
    border-radius: 4px;
  }

  #film-content h2[id]{
  scroll-margin-top: 90px;
}

/* Awards */
#film-content h2#awards + ul,
#film-content h2[id="awards"] + ul {
  list-style: none;
  padding-left: 0;
  margin-left: 0;
}

#film-content .award-item {
  padding: 1.05em 0;
}

#film-content .award-item + .award-item {
  margin-top: 0.55em;
}

#film-content .award-item .festival {
  font-size: clamp(0.98em, 0.96em + 0.18vw, 1.10em);
  font-weight: 500;
  color: rgba(255, 255, 255, 0.90);
  letter-spacing: 0.01em;
  line-height: 1.45;
}

#film-content .award-item .award-meta {
  margin-top: 0.30em;
  font-size: clamp(0.92em, 0.90em + 0.12vw, 1.00em);
  font-weight: 400;
  color: rgba(255, 255, 255, 0.62);
  line-height: 1.7;
}

/* Credits */
#film-content .credits {
  margin-top: 0.6em;
}

#film-content .credit + .credit {
  margin-top: 0.85em;
}

#film-content .credit {
  display: grid;
  grid-template-columns: 13.5em 1fr;
  column-gap: 1.6em;
  align-items: start;
}

#film-content .credit .role {
  font-size: clamp(0.90em, 0.88em + 0.10vw, 0.98em);
  font-weight: 400;
  color: rgba(255, 255, 255, 0.58);
  letter-spacing: 0.01em;
  line-height: 1.4;
}

#film-content .credit .name {
  font-size: clamp(0.95em, 0.93em + 0.10vw, 1.02em);
  font-weight: 400;
  color: rgba(255, 255, 255, 0.86);
  line-height: 1.7;
}

  /* Mobile stack */
  @media (max-width: 640px) {
    #film-content .credit {
      grid-template-columns: 1fr;
      row-gap: 0.35em;
    }
  }
</style>


<script>
  function initSectionTabs() {
    const article = document.getElementById('film-content');
    const tabNav = document.getElementById('section-tabs');
    const tabsContainer = document.getElementById('tabs-container');

    // 1. Safety Check
    if (!article || !tabNav || !tabsContainer) return;

    // 2. Find Headings
    const headings = article.querySelectorAll('h2[id]');
    if (headings.length === 0) return;

    // 3. Setup Navigation Position
    // Move the tab nav right before the first h2
    const firstH2 = headings[0];
    firstH2.parentNode?.insertBefore(tabNav, firstH2);
    tabNav.classList.remove('hidden');

    // Clear container in case script runs multiple times (common in Astro)
    tabsContainer.innerHTML = '';

    // 4. Helper function to update classes
    function setActiveTab(targetId) {
      const tabs = tabsContainer.querySelectorAll('.section-tab');
      tabs.forEach((tab) => {
        const isTarget = tab.dataset.target === targetId;
        tab.classList.toggle('active', isTarget);
      });

      // Keep active tab visible in the horizontal scroll
      const active = tabsContainer.querySelector('.section-tab.active');
      active?.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
    }

    // 5. Create Tab Buttons
    headings.forEach((heading) => {
      const btn = document.createElement('button');
      btn.className = 'section-tab';
      btn.textContent = heading.textContent || '';
      btn.dataset.target = heading.id;

      btn.addEventListener('click', () => {
        const target = document.getElementById(heading.id);
        if (target) {
          // Calculate offset (nav height + extra spacing)
          const offset = tabNav.offsetHeight + 20;
          const top = target.getBoundingClientRect().top + window.scrollY - offset;
          window.scrollTo({ top, behavior: 'smooth' });
        }
      });

      tabsContainer.appendChild(btn);
    });

    // 6. Active State Tracking (IntersectionObserver)
    const observer = new IntersectionObserver(
      (entries) => {
        // Find the first heading currently entering the "viewing zone"
        const visibleEntry = entries.find((entry) => entry.isIntersecting);
        if (visibleEntry) {
          setActiveTab(visibleEntry.target.id);
        }
      },
      {
        // This margin ensures the tab switches when heading is near the top
        rootMargin: '-15% 0px -70% 0px',
        threshold: 0,
      }
    );

    headings.forEach((heading) => observer.observe(heading));

    // Set first tab as active by default
    if (headings.length > 0) {
      setActiveTab(headings[0].id);
    }
  }

  // Runs on initial load
  initSectionTabs();

  // Runs on Astro view transitions (if enabled)
  document.addEventListener('astro:after-swap', initSectionTabs);
</script>
